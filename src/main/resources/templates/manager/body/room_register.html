<!doctype html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
  <head>
      <div th:replace="~{/common/fragments/head :: common-head}"></div>
      <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.0.7/dist/js/splide.min.js"></script>
      <!-- or link to the CDN -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.0.7/dist/css/splide.min.css">
      <script src="https://cdn.ckeditor.com/ckeditor5/35.0.1/classic/ckeditor.js"></script>

  </head>
  <body>
    <!-- Navigation-->
    <div th:replace="~{/common/fragments/nav :: fragment-nav}"></div>

    <div class="text-center my-5">
        <!--
        <h1 class="fw-bolder">Welcome to Blog Home!</h1>
        <p class="lead mb-0">A Bootstrap 5 starter layout for your next blog homepage</p>
        -->
    </div>

    <!-- PageContent -->
    <div class="container px-4 px-lg-5 w-75">
        <div class="d-flex my-2 justify-content-end">
            <button class="btn btn-outline-primary" type="button">방 등록하기</button>
        </div>
        <div class="row">
            <!-- Blog entries-->
            <div class="col-lg-6">
                <!-- Featured blog post-->
                <div class="card mb-4" x-data>
                    <div class="card-header">
                        <div class="d-inline">
                            <span class="align-middle text-primary fw-bold">사진등록</span>
                        </div>
                        <label :class="$store.fileInfo.fileCount < 10 ? 'btn btn-sm btn-primary text-white float-end' : 'btn btn-sm btn-primary text-white float-end disabled'" for="input-file">
                            사진 추가
                        </label>
                        <input type="file" multiple id="input-file" class="d-none" @change="addFile"/>
                    </div>
                    <a href="#!"><img class="card-img-top" :src="$store.fileInfo.src" width="850" height="450" /></a>
                    <div class="card-body">
                        <div id="thumbnail-carousel" class="splide">
                            <div class="splide__track">
                                <ul class="splide__list">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Side widgets-->
            <div class="col-lg-6">
                <!-- Search widget-->
                <div class="card mb-4">
                    <div class="card-header text-primary fw-bold">제목</div>
                    <div class="card-body">
                        <div>
                            <input class="form-control" type="text" />
                        </div>
                    </div>
                </div>
                <!-- Categories widget-->
                <div class="card mb-4">
                    <div class="card-header text-primary fw-bold">공간 소개</div>
                    <div class="card-body">
                        <div id="editor"></div>
                    </div>
                </div>
                <!-- Side widget-->
                <div class="card mb-4">
                    <div class="card-header">Side Widget</div>
                    <div class="card-body">You can put anything you want inside of these side widgets. They are easy to use, and feature the Bootstrap 5 card component!</div>
                </div>
            </div>
        </div>
    </div>

    <div class="my-5 py-2">
    </div>
    <!-- Footer-->
    <div th:replace="~{/common/fragments/footer :: common-footer}"></div>

    <script>
        const fileInfos = new Array();
        var index = 0;
        const splide = new Splide( '#thumbnail-carousel', {
                type : 'slide',
                fixedWidth : 100,
                gap        : 10,
                focus    : 'center',
          } );

        document.addEventListener( 'DOMContentLoaded', function () {
          splide.mount();
        } );

        function addFile(e) {
            const files = e.target.files;
            console.log(files);
            if(fileInfos.length + files.length > 10) {
                alert("파일을 10개 초과하여 등록할 수 없습니다.");
                return;
            }

            if(files.length > 0){
                let step;
                let src;
                for (step = 0; step < files.length; step++) {
                    const file = files.item(step);
                    let fileInfo = {file : file, key : index++};
                    src = URL.createObjectURL(file);
                    fileInfos.push(fileInfo);
                    splide.add( `<li class="splide__slide">
                                <div class="card">
                                    <div class="card-header p-0">
                                        <button type="button" class="btn-close float-end" @click="removeFile(${fileInfo.key})" style="width: 0.25em; height: 0.25em;"></button>
                                    </div>
                                    <a href="#!" x-on:click="onFile(${fileInfo.key})"><img src="${src}" width="100" height="100" alt=""></a>
                                </div>
                            </li>` );
                }
                Alpine.store('fileInfo').change(src);
                Alpine.store('fileInfo').fileCount = fileInfos.length;
            }
        }

        function removeFile(key){
            let step;
            for (step = 0; step < fileInfos.length; step++) {
                if(fileInfos[step].key == key){
                    fileInfos.splice(step, 1);
                    splide.remove(step);
                    Alpine.store('fileInfo').fileCount = fileInfos.length;
                    onFile(fileInfos[0].key);
                    return;
                }
            }
        }

        function onFile(key){
            let step;
            let filesSrc;
            for (step = 0; step < fileInfos.length; step++) {
                if(fileInfos[step].key == key){
                    filesSrc = URL.createObjectURL(fileInfos[step].file);
                    Alpine.store('fileInfo').change(filesSrc);
                    console.log(filesSrc);
                    return;
                }
            }
        }

        document.addEventListener('alpine:init', () => {
            Alpine.store('fileInfo', {
                src: 'https://dummyimage.com/850x650/dee2e6/6c757d.jpg',
                fileCount : 0,
                change(src) {
                    this.src = src
                }
            })
        })

        ClassicEditor
        .create( document.querySelector( '#editor' ) )
        .catch( error => {
            console.error( error );
        } );

    </script>

</body>
</html>